# cellxhaustive

A python package for performing an exhaustive search of cell phenotypes.

## Installation

### Using `pip`

You can install `cellxhaustive` from TestPyPI:

```bash
pip install -i https://test.pypi.org/simple/ cellxhaustive --extra-index-url https://pypi.python.org/simple
```

### Using `mamba`

You can install the package requirements in a dedicated `mamba` environment. To do so, follow the next steps:

```bash
git clone git@github.com:bernibra/cellxhaustive.git # Clone repository
cd cellxhaustive  # Go into cloned repository
mamba env create -f mamba_env.yaml  # Create computing environment
```

This will create a specific environment called `cellxhaustive`, that can later be activated with `mamba activate cellxhaustive`.

Note: if you don't have `mamba` installed, you can find instructions [here](https://mamba.readthedocs.io/en/latest/installation/mamba-installation.html) explaining how to install it.

## Quickstart

To quickly check what the package does and how it works, you can use it with the provided test dataset:

```bash
cd cellxhaustive  # Go into repository
mamba activate cellxhaustive  # Activate computing environment
python src/cellxhaustive/cellxhaustive.py -i test/data/test_data.tsv -m test/data/test_markers.txt -o test/results/test_data_annotated.tsv  # Run analyses
```

More information on the detailed functioning of the package can be found in the [next section](#usage).

## Usage

`cellxhaustive` is run from the command line. The core script is located in:

```bash
src/cellxhaustive/cellxhaustive.py
```

Example:

 ```bash
python /RELATIVE/PATH/TO/cellxhaustive/src/cellxhaustive/cellxhaustive.py -i data.tsv -m markers.txt -o results/results.tsv --log results/results.log -a 9 -e CD4 -q 0.9 -r 10 -t 4
 ```

### Mandatory parameters

`cellxhaustive` has 3 mandatory parameters, namely:
- `-i`, `--input INPUT_PATH`: path to the input table with expression data and samples/batch/cell_type information. Must be a string
- `-m`, `--markers MARKER_PATH`: path to the input file with list of markers of interest that will be used. Must be a string
- `-o`, `--output OUTPUT_PATH`: path to output file where data will be written. Must be a string

These parameters as well as the file contents will be explained in more details in the following sections.

#### Input file

The input file should be a `Tab-Separated Values` (`.tsv`) table with:
- **Header row** containing column names.
- **Each row** representing a single cell.
- **Columns** for :
    - Marker expression values (one column per marker). Values must be normalized.
    - Metadata: sample and batch. A batch may contain multiple samples, but each sample must belong to only one batch.

Example:

| | CD3 | CD4 | CD8 | sample | batch |
| --- | --- | --- | --- | --- | --- |
| Cell 1| 1.4 | 3.4 | 3.2 | sample1 | batch1 |
| Cell 2 | 6.0 | 4.4 | 0.2 | sample1 | batch1 |
| Cell 3 | 4.3 | 2.4 | 1.9 | sample2 | batch1 |



#### Markers file

The markers file should be a `.txt` file listing marker names (one per line).
Theses markers should be present as column headers in the `input file`.

Example:

```txt
CD3
CD4
CD8
```

#### Output

The output file is a `Tab-Separated Values` (`.tsv`) table which includes:
- All columns from the input file.
- If one or more solutions, new columns:
    - `Annotations_i`: predicted annotations for the *i-th* marker combination.
    - `Phenotypes_i`: corresponding phenotype label derived from `Annotations_i`.
    - If KNN refinement is enabled:
        - `KNN_annotations_i`: refined annotations using KNN classification for the *i-th* marker combination
        - `KNN_phenotype_i`: phenotype label based on `KNN_annotations_i`.
        - `KNN_proba_i`: probability associated with the KNN prediction.


### Optional parameters

All the following parameters are optional and are preset with default values. As such, they do not strictly need to be specified to run the analyses, but they can be very useful to tweak the analyses or reduce the computational burden.

- `-l`, `--log LOG_PATH`: path to the file containing the log messages generated by the script. By default, it is the same path than the output file, except it finishes with the `.log` extension. Must be a string
- `-n`, `--log-level LOG_LEVEL`: verbosity level of log file. Set to `info` by default. Must be `debug`, `info` or `warning`
    - `debug` will often produce a very heavy file (>100 MB) and should be used if you are interested in the detailed progression of the analyses
    - `warning` will produce a very empty file and should be used only if you don't need the basic analysis information
- `-a`, `--max-markers MAX_MARKERS`: maximum number of relevant markers to select among the total list of markers. Must be less than or equal to the number of markers available in `INPUT_PATH`. Set to 15 by default. Must be a positive integer.
- `-mi`, `--markers-interest MARKERS_INTEREST`: comma-separated list of markers of interest that must appear in the final combination. Each resulting marker combination must include all specified markers. Empty by default.
- `-j`, `--thresholds THRESHOLDS`: Comma seperated list of 3 floats defining thresholds to determine whether markers are negative or positive. 
    - 1st number is for two peaks markers. Set to 3 by default. Expression below this threshold means the marker will be considered negative. Expression above this threshold means the marker will be considered positive
    - Last 2 numbers are for three peaks markers. Set to 2 and 4 by default. Expression below the first threshold means the marker will be considered negative. Expression above the second threshold means the marker will be considered positive. Expression in between both thresholds means the marker will be considered low positive
- `-e`, `--three-peaks THREE_PEAK_MARKERS`: path to the file containing a list of markers that have three peaks or comma separated list of markers that have three peaks. If specified, file must contain one marker per line. Empty by default.
- `-c`, `--cell-type-definition CELL_TYPE_PATH`: path to the `.yaml` file specifying relationships between marker status and cell type ontology. Default is `../data/config/major_cell_types.yaml`.
- `-q`, `--min-samplesxbatch MIN_SAMPLESXBATCH`: minimum proportion of samples within each batch with at least `MIN_CELLXSAMPLE` cells for a new annotation to be considered. Set to 0.5 by default. Must be a positive float number in `[0.01; 1]`
    - In other words, by default, an annotation needs to be assigned to at least 10 cells/sample (see description of next parameter) in at least 50% of samples within a batch to be considered
- `-r`, `--min-cellxsample MIN_CELLXSAMPLE`: minimum number of cells within each sample in `MIN_SAMPLESXBATCH` proportion of samples within each batch for a new annotation to be considered. Set to 10 by default. Must be a positive integer in `[1; 100]`
    - In other words, by default, an annotation needs to be assigned to at least 10 cells/sample in at least 50% of samples (see description of previous parameter) within a batch to be considered
- `-nk`, `--no-knn`: if present, do not refine annotations with a KNN classifier. Missing by default, which means the annotations will be improved using a KNN-classifier. This is a boolean flag, no argument needed.
- `-p`, `--knn-min-probability KNN_MIN_PROBABILITY`: confidence threshold for a KNN-classifier to reassign a new cell type to previously undefined cells. Set to 0.5 by default. Must be a positive float number in `[0; 1]`
    - A KNN probability below this threshold means the classifier will not reassign a new cell type to an undefined cell
    - A KNN probability above this threshold means the classifier will reassign a new cell type to an undefined cell
- `-t`, `--threads THREADS`: number of CPU cores to use. Using more than one allows parallel processing (default: 1). Must be a strictly positive integer.
- `-dm`, `--detection-method`: method used to determine the best marker combination length. Can be:
  - `'auto'`: use the default heuristic algorithm (default).
  - Integer: set a fixed combination length manually. Must be less than `MAX_MARKERS`.
- `-b`, `--config CONFIG`: path to a config file that provides cell type–specific detection methods and `MARKER_INTEREST` setting. Empty by default.
- `-d`, `--dry-run DRY_RUN`: if present, activates dry-run mode to check all inputs and configuration without running the full analysis. No argument is needed after this flag.


### Help

You can access the package help and get a summary of the parameters with:

```bash
python cellxhaustive.py -h
```


## Contributing

Interested in contributing? Check out the [contributing guidelines](CONTRIBUTING.md). Please note that this project is released with a [Code of Conduct](CONDUCT.md). By contributing to this project, you agree to abide by its terms.

## License

`cellxhaustive` was created by Bernat Bramon Mora and Antonin Thiébaut. It is licensed under the terms of the [MIT license](LICENSE).

## Credits

`cellxhaustive` was created with [`cookiecutter`](https://cookiecutter.readthedocs.io/en/latest/) and the `py-pkgs-cookiecutter` [template](https://github.com/py-pkgs/py-pkgs-cookiecutter).
